@version: 4.10
@include "scl.conf"

# Syslog-ng configuration for JSON output with log rotation
# Compatible with syslog-viewer web interface

# Options
options {
    # Increase performance
    threaded(yes);
    chain_hostnames(no);

    # Keep timestamps from the original message
    keep_hostname(yes);
    keep_timestamp(yes);

    # Enable statistics (updated syntax for 4.10)
    stats(
        freq(3600)
        level(1)
    );
};

# Source: UDP syslog on port 514
source s_udp {
    network(
        transport("udp")
        port(514)
        flags(no-parse)
        keep-hostname(yes)
    );
};

# Source: TCP syslog on port 514
source s_tcp {
    network(
        transport("tcp")
        port(514)
        flags(no-parse)
        keep-hostname(yes)
        max-connections(100)
    );
};

# Template: JSON Lines format matching Python syslog server output
template t_json {
    template("$(format-json
        timestamp=\"$ISODATE\"
        source=\"$SOURCEIP\"
        protocol=\"${.protocol}\"
        facility=\"$FACILITY\"
        severity=\"$LEVEL\"
        priority=\"$PRI\"
        message=\"$MESSAGE\"
        raw=\"$RAWMSG\"\n)");
};

# Template: For adding protocol metadata
rewrite r_add_protocol_udp {
    set("UDP", value(".protocol"));
};

rewrite r_add_protocol_tcp {
    set("TCP", value(".protocol"));
};

# Destination: JSON Lines file with rotation
destination d_jsonl {
    file(
        "/app/logs/syslog.jsonl"
        template(t_json)

        # Log rotation settings
        create-dirs(yes)
        dir-perm(0755)
        perm(0644)

        # Size-based rotation (100MB)
        log-fifo-size(10000)

        # Note: syslog-ng doesn't have built-in size rotation
        # We'll use logrotate for that (see logrotate.conf)
    );
};

# Destination: Console output for debugging
destination d_console {
    file("/proc/1/fd/1" template("$ISODATE $SOURCEIP [$LEVEL] $MESSAGE\n"));
};

# Log paths: Connect sources to destinations
log {
    source(s_udp);
    rewrite(r_add_protocol_udp);
    destination(d_jsonl);
    destination(d_console);
    flags(flow-control);
};

log {
    source(s_tcp);
    rewrite(r_add_protocol_tcp);
    destination(d_jsonl);
    destination(d_console);
    flags(flow-control);
};
