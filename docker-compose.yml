name: syslog-ng-stack

services:
  # Syslog-ng Server - Enterprise-grade syslog receiver with built-in rotation
  syslog-ng-server:
    image: ghcr.io/${GITHUB_REPOSITORY:-superjc710e/syslog-ng-stack}/syslog-ng-server:latest
    build:
      context: ./syslog-ng-server
      dockerfile: Dockerfile
    container_name: syslog-ng-server
    ports:
      - "514:514/udp"    # Syslog UDP
      - "514:514/tcp"    # Syslog TCP
    restart: unless-stopped
    cap_add:
      - NET_BIND_SERVICE
      - DAC_READ_SEARCH
      - SYSLOG
    environment:
      - TZ=UTC
    volumes:
      - syslog-data:/app/logs
    networks:
      - syslog-net
    healthcheck:
      test: ["CMD", "syslog-ng-ctl", "healthcheck", "--timeout", "5"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Syslog Viewer - Web interface for viewing logs
  syslog-viewer:
    image: ghcr.io/${GITHUB_REPOSITORY:-superjc710e/syslog-ng-stack}/syslog-viewer:latest
    build:
      context: ./syslog-viewer
      dockerfile: Dockerfile
    container_name: syslog-ng-viewer
    ports:
      - "8080:8080"      # Web interface
    restart: unless-stopped
    environment:
      - TZ=UTC
    volumes:
      - syslog-data:/app/logs:ro  # Read-only access to logs
    networks:
      - syslog-net
    depends_on:
      syslog-ng-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/api/logs')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  syslog-data:
    driver: local

networks:
  syslog-net:
    driver: bridge
